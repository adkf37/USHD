####################################################################################################
## Description: Reads in the model draws, fixed effects, and labels generated by pred_draws and then 
##              calculates the draws for a particular chunk of draws (read in by the array job).
##              Also calculates the age-standardized and all-age values.
##              Saves this chunk of draws for all ages/locations/races for each year separately.
##
## Passed args: dir [character] -- home directory for settings and final output
##              sex [integer] -- sex to generate predictions for
##              race [integer] -- race to generate predictions for
##              validate [logical] -- is this a validation model? if so, only mx draws for
##                areas in the validation set are created
##              resub [logical] -- are you resubmitting? if yes, it will not re-save files that already
##                exist (or where the final file with all draws exists)
##              * note that the range of subdraws is read in from an array job
##
## Requires:    prepped data file ("[dir]/data.rds")
##              file specifying areas in the validation set, if validate is T (gs_file)
##              populations (pop_file)
##              age standard file (age_std_file)
##              draws generated by pred_mx ([dir]/initial_sims_[sex]_[race].rds)
##              fixed effects generated by pred_mx ([dir]/fe_sims_[sex]_[race].rds)
##              names of the effects used for subsetting the draws ([dir]/mean_[sex]_[race].rds)
##
## Outputs:     mx draws and estimates, saved in separate files by year and draw "chunk":
##                "[dir]/mx_draws_[area_var]_[year]_[sex]_[race]_[max_subdraw].rds"
##
####################################################################################################

###### Load required libraries
pacman::p_load(R.utils, data.table, Matrix, splines, boot, doParallel, foreach, parallel, TMB)

###### Set up objects from command args
if (!interactive()) {
  (repo <- commandArgs(TRUE)[[1]])
  (output_dir <- commandArgs(TRUE)[[2]])
  (settings_loc <- commandArgs(TRUE)[[3]])
  (sex <- commandArgs(TRUE)[[4]])
  (race <- as.integer(commandArgs(TRUE)[5]))
  (validate <- as.logical(commandArgs(TRUE)[6]))
  (resub <- as.logical(commandArgs(TRUE)[7]))
  (by_sex <- as.logical(commandArgs(TRUE)[8]))
  (output_dir_draws_est <- commandArgs(TRUE)[9])
  (by_source <- commandArgs(TRUE)[[10]])
  (imp <- commandArgs(TRUE)[11])
} else {
  sex <- 1
  race <- 99
  imp <- 0
}

###### Source functions
funcs <- list.files(paste0(repo, "/functions/"))
for (func in funcs[!funcs %in% "load_sae_shared.R"]) {
  source(paste0(repo, "/functions/", func))
}

###### Assign settings from settings file
get_settings(settings_loc)

if (outcome == "pred_bmi") {
  dir_string <- ""
} else {
  dir_string <- paste0("_", imp)
}

set.seed(12345)

if (!exists("by_source")) {
  by_source <- FALSE
}

## Load model fit -------------------------------------------------------------------------
if (is.null(race_together)) race_together <- FALSE

if (race_together) {
  if (by_sex) {
    # read in the model
    out <- readRDS(paste0(output_dir, "/model_fit_", sex, "_", imp, ".rds"))
    mod <- get_params(paste0(output_dir, "/model_fit_", sex, "_", imp, ".rds"))
  } else {
    # read in the model
    out <- readRDS(paste0(output_dir, "/model_fit.rds"))
    mod <- get_params(paste0(output_dir, "/model_fit.rds"))
  }
} else {
  if (by_sex) {
    # read in the model
    out <- readRDS(paste0(output_dir, "/model_fit_", sex, "_", race, "_", edu, ".rds"))
    mod <- get_params(paste0(output_dir, "/model_fit_", sex, "_", race, "_", edu, ".rds"))
  } else {
    # read in the model
    out <- readRDS(paste0(output_dir, "/model_fit.rds"))
    mod <- get_params(paste0(output_dir, "/model_fit.rds"))
  }
}

#### Load recode mapping and num vars
recode <- readRDS(paste0(output_dir, "/recode.rds"))
load(paste0(output_dir, "/num_vars.RData"))

#### Set gold_standard_source
if (!exists("gold_standard_source")) {
  gold_standard_source <- NULL
}

#### Load prediction frame
if (by_sex) {
  pred_frame <- readRDS(paste0(output_dir, "/pred_frame_", sex, ".rds"))
} else {
  pred_frame <- readRDS(paste0(output_dir, "/pred_frame.rds"))
}

if ("state" %in% names(pred_frame)) {
  setkeyv(pred_frame, c("area", "state", "year", "sex", "race", "age"))
} else {
  setkeyv(pred_frame, c("area", "year", "sex", "race", "age"))
}

#### Load covariates and merge onto pred_frame
if (length(covars) != 0) {
  cov <- readRDS(paste0(output_dir, "/covariates.rds"))
  pred_frame <- merge(pred_frame, cov, by = c("area", "year", "sex", "race", "age"), all.x = TRUE)
  
  ## Standardize covars
  covariates <- readRDS(paste0(output_dir, "/covariates.rds"))
  covars <- names(covariates)[!(names(covariates) %in% c("area", "year", "sex", "age", "race", "level", "state"))]
}

task_id <- ifelse(is.na(as.integer(Sys.getenv("SLURM_ARRAY_TASK_ID"))), 1, as.integer(Sys.getenv("SLURM_ARRAY_TASK_ID")))
draw_args <- fread(paste0(output_dir_draws_est, "/draw_args_", sex, "_", race, "_", edu, ".csv"))
draw_val <- c(draw_args[task_id, start_draw]:draw_args[task_id, end_draw])

cl <- parallel::makeCluster(10)
doParallel::registerDoParallel(cl)

draws <- foreach(m = 1:n.imp, .combine = "cbind", .packages = c("data.table", "R.utils", "Matrix", "splines", "boot")) %dopar% {
  output_dir_draws_est_temp <- paste0(dirname(output_dir_draws_est), "/imputation", m, "/")
  output_dir_temp <- paste0(dirname(output_dir), "/imputation", m, "/")
  
  ## read in array arguments
  ## get the draw value
  if (by_sex) {
    re_file <- paste0(output_dir_draws_est_temp, "/initial_sims_", sex, "_", race, "_", m, "_", edu, ".rds")
    
    if (!file.exists(re_file)) {
      warning(paste0("File ", re_file, " does not exist!"))
      return(NULL)
    }
    sims <- readRDS(re_file)
    mean <- readRDS(paste0(output_dir_draws_est_temp, "/mean_", sex, "_", race, "_", m, "_", edu, ".rds"))
  } else {
    re_file <- paste0(output_dir_draws_est, "/initial_sims_", race, "_", m, ".rds")
    
    sims <- readRDS(re_file)
    mean <- readRDS(paste0(output_dir_draws_est, "/mean_", race, "_", m, ".rds"))
  }
  
  sims <- sims[, draw_val]
  
  # the simvars are not actually the draw vals because when the matrices get subset the column numbers change
  simvars <- paste0("V", 1:length(draw_val))
  
  # Get spline information, if present in settings.csv
  if (!is.null(age_knots_spec)) {
    age_knots <- which(ages %in% age_knots_spec) - 1
    s_age <- as.data.table(bs((1:num_a) - 1, knots = age_knots[1:(length(age_knots) - 1)], degree = 1, intercept = F)) 
  }
  
  if (!is.null(year_knots_num)) {
    year_knots <- seq(1, length(years), length.out = year_knots_num) - 1
    s_year <- as.data.table(bs((1:num_t) - 1, knots = year_knots[1:(length(year_knots) - 1)], degree = 1, intercept = F)) 
  }
  
  # calculate draws for the fixed portion of the model
  if (grepl("state_model", model)) {
    # Load full data set (that did not drop NA agg weights) to get cov values and scale with same mean and SD as modeling data
    if (!cross_val) {
      data <- readRDS(paste0(output_dir_temp, "/data_full_", m,".rds"))
    } else {
      data <- readRDS(paste0(output_dir_temp, "/data_full.rds"))
    }
    
    mod_data <- readRDS(paste0(output_dir_temp, "/data_", m,".rds"))
    
    if ("state" %in% names(pred_frame)) {
      setkeyv(mod_data, c("area", "state","year", "sex", "race", "age"))
      setkeyv(data, c("area", "state", "year", "sex", "race", "age"))
    } else {
      setkeyv(mod_data, c("area", "year", "sex", "race", "age"))
      setkeyv(data, c("area", "year", "sex", "race", "age"))
    } # same as pred_frame
    
    ###### Transform covariates
    if (!is.null(covars_trans)) {
      for (var in names(covars_trans)) {
        ## Pull out function to be used to transform vars
        ## and covars to be transformed are stored in names of the vector
        fun <- eval(parse(text = paste("function(x)", covars_trans[var])))
        eval(parse(text = paste0("data$", var, " <- fun(data$", var, ")")))
        
        # subs ylls are always 0 for ages under 15 and resp ylls are always 0
        # for ages under 1 so results in -Inf vals. 
        # If not set back to NA, draws are always NA for those ages when added
        # to other effect (function later on changes NAs to 0s before it gets 
        # added to linear predictor)
        if (var == "subs") {
          data[age < recode$age[age == 15, age_recode], subs := NA]
        }
        
        if (var == "resp") {
          data[age < recode$age[age == 1, age_recode], resp := NA]
        }
      }
    }
    
    ###### Scale covariates in prediction data to same scale as model data
    for (col in covars_scale) {
      dt_center <- eval(parse(text = paste0("attr(mod_data$", col,", 'scaled:center')")))
      dt_scale <- eval(parse(text = paste0("attr(mod_data$", col,", 'scaled:scale')")))
      eval(parse(text = paste0("data$", col, " <- scale(data$", col, ")")))
    }
    rm(mod_data)
    
    # subset the data
    sex_var <- copy(sex)
    data <- data[sex == recode$sex[sex == sex_var, sex_recode],]
    data[, int := 1]
    if ("state" %in% names(pred_frame)) {
      setkeyv(data, c("area", "state","year", "sex", "race", "age"))
    } else {
      setkeyv(data, c("area", "year", "sex", "race", "age"))
    } # same as pred_frame
    
    # Check order of rows is the same (check if subsetting cols changes order of DT)
    if (!all.equal(pred_frame[, list(int, area, year, sex, race, age)], data[, list(int, area, year, sex, race, age)])) {
      stop("pred_frame and data for covariates are not equal")
    }
    
    # Global intercept
    B_0 <- sims[grepl("^B", names(mean)) & !grepl("^B1", names(mean)) & !grepl("^B2", names(mean)) & !grepl("^B3", names(mean)) & !grepl("^B4", names(mean)) & !grepl("^B5", names(mean)) & !grepl("^B6", names(mean)) & !grepl("^B7", names(mean)) & !grepl("^B8", names(mean)) & !grepl("^B9", names(mean)),]
    fe_0 <- as.matrix(data[, c("int"), with = F]) %*% B_0
    
    data[, index := .I] # add index to help with merges
    
    if (!(model %in% c("state_model41", "state_model42"))) {
      B_1 <- sims[grepl("^B1", names(mean)),]
      
      # Multiply covariate values by fixed effect
      fe_1 <- as.matrix(data[, c(covars_subpop), with = F]) %*% B_1
      
      fe <- fe_0 + fe_1
    } else {
      fe <- fe_0
    }
    
    # define function
    replace_na_func <- function(x) ifelse(is.na(x), 0, x)
    
    B_2 <- sims[grepl("^B2", names(mean)),]
    # Value of covariates are NA for those under 20 -> set to 0
    data[, (covars_subpop_20plus) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_20plus]
    
    # Multiply covariate values by fixed effect
    fe_2 <- as.matrix(data[, c(covars_subpop_20plus), with = F]) %*% B_2
    # Set fe2 to 0 for ages under 20
    fe_2 <- fe_2 * as.integer(data[, age >= recode$age[age == 20, age_recode]])
    
    fe <- fe + fe_2
    
    if (!(model %in% c("state_model41", "state_model42", "state_model49", "state_model50", "state_model51"))) {
      B_3 <- sims[grepl("^B3", names(mean)),]
      # Value of covariates are NA for those in age groups over 60-64
      data[, (covars_subpop_60under) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_60under]
      
      # Multiply covariate values by fixed effect
      fe_3 <- as.matrix(data[, c(covars_subpop_60under), with = F]) %*% B_3
      # Set fe3 to 0 for ages over 60
      fe_3 <- fe_3 * as.integer(data[, age <= recode$age[age == 60, age_recode]])
      fe <- fe + fe_3
    }
    
    if (model %in% c("state_model13", "state_model15", "state_model37",  "state_model38", "state_model39", 
                     "state_model40", "state_model41", "state_model42", 
                     "state_model44", "state_model45", "state_model46", "state_model49", "state_model50", "state_model51")) {
      B_4 <- sims[grepl("^B4", names(mean)),]
      # Value of covariates are NA for those in age groups over 5
      data[, (covars_subpop_5plus) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_5plus]
      
      # Multiply covariate values by fixed effect
      fe_4 <- as.matrix(data[, c(covars_subpop_5plus), with = F]) %*% B_4
      # Set fe4 to 0 for ages under 5
      fe_4<- fe_4 * as.integer(data[, age >= recode$age[age == 5, age_recode]])
      fe <- fe + fe_4
    }
    
    if (model %in% c("state_model46", "state_model50")) {
      B_6 <- sims[grepl("^B6", names(mean)),]
      # Value of covariates are NA for those in age groups over 1
      data[, (covars_subpop_1plus) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_1plus]
      
      # Multiply covariate values by fixed effect
      fe_6 <- as.matrix(data[, c(covars_subpop_1plus), with = F]) %*% B_6
      # Set fe6 to 0 for ages under 1
      fe_6 <- fe_6 * as.integer(data[, age >= recode$age[age == 1, age_recode]])
      fe <- fe + fe_6
    }
    
    if (model %in% c("state_model30")) {
      B_5 <- sims[grepl("^B5", names(mean)),]
      # Value of covariates are NA for those in age groups over 5
      data[, (covars_subpop_5plus) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_5plus]
      
      # Multiply covariate values by fixed effect
      fe_5 <- as.matrix(data[, c(covars_subpop_5plus), with = F]) %*% B_5
      # Set fe5 to 0 for ages under 5
      fe_5 <- fe_5 * as.integer(data[, age >= recode$age[age == 5, age_recode]])
      fe <- fe + fe_5
    }
    
    if (model %in% c("state_model15", "state_model24", "state_model32")) {
      B_5 <- sims[grepl("^B5", names(mean)),]
      # Value of covariates are NA for those in age groups over 1
      data[, (covars_subpop_1plus) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_1plus]
      
      # Multiply covariate values by fixed effect
      fe_5 <- as.matrix(data[, c(covars_subpop_1plus), with = F]) %*% B_5
      # Set fe5 to 0 for ages under 1
      fe_5 <- fe_5 * as.integer(data[, age >= recode$age[age == 1, age_recode]])
      fe <- fe + fe_5
    }
    
    if (model %in% c("state_model20", "state_model26", "state_model20_starting_values", "state_model31", 
                     "state_model40", "state_model45", "state_model51")) {
      B_5 <- sims[grepl("^B5", names(mean)),]
      # Value of covariates are NA for those in age groups over 15
      data[, (covars_subpop_15plus) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_15plus]
      
      # Multiply covariate values by fixed effect
      fe_5 <- as.matrix(data[, c(covars_subpop_15plus), with = F]) %*% B_5
      # Set fe5 to 0 for ages under 15
      fe_5<- fe_5 * as.integer(data[, age >= recode$age[age == 15, age_recode]])
      fe <- fe + fe_5
    }
    
    if (model %in% c("state_model20", "state_model26", "state_model20_starting_values")) {
      B_4 <- sims[grepl("^B4", names(mean)),]
      # Value of covariates are NA for those in age groups over 15
      data[, (covars_subpop_15plus) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_15plus]
      
      # Multiply covariate values by fixed effect
      fe_4 <- as.matrix(data[, c(covars_subpop_15plus), with = F]) %*% B_4
      # Set fe4 to 0 for ages under 5
      fe_4<- fe_4 * as.integer(data[, age >= recode$age[age == 15, age_recode]])
      fe <- fe + fe_4
    }
    
    if (model %in% c("state_model37", "state_model38", "state_model39", "state_model40", "state_model41")) {
      B_6 <- sims[grepl("^B6", names(mean)),]
      data[, (covars_subpop_5_to_15) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_5_to_15]
      
      # Multiply covariate values by fixed effect
      fe_6 <- as.matrix(data[, c(covars_subpop_5_to_15), with = F]) %*% B_6
      # Set fe 0 for ages outside of range
      fe_6 <- fe_6 * as.integer(data[, age %in% recode$age[age %in% c(5:15), age_recode]])
      fe <- fe + fe_6
    }
    
    if (model %in% c("state_model37", "state_model39", "state_model40", "state_model41", "state_model42")) {
      B_7 <- sims[grepl("^B7", names(mean)),]
      data[, (covars_subpop_65plus) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_65plus]
      
      # Multiply covariate values by fixed effect
      fe_7 <- as.matrix(data[, c(covars_subpop_65plus), with = F]) %*% B_7
      # Set fe 0 for ages outside of range
      fe_7 <- fe_7 * as.integer(data[, age %in% recode$age[age %in% c(65:85), age_recode]])
      fe <- fe + fe_7
    }
    
    if (model %in% c("state_model39", "state_model40")) {
      B_8 <- sims[grepl("^B8", names(mean)),]
      data[, (covars_subpop_20_to_60) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_20_to_60]
      
      # Multiply covariate values by fixed effect
      fe_8 <- as.matrix(data[, c(covars_subpop_20_to_60), with = F]) %*% B_8
      # Set fe 0 for ages outside of range
      fe_8 <- fe_8 * as.integer(data[, age %in% recode$age[age %in% c(20:60), age_recode]])
      fe <- fe + fe_8
    }
    
    if (model %in% c("state_model39", "state_model41", "state_model42")) {
      B_9 <- sims[grepl("^B9", names(mean)),]
      data[, (covars_subpop_5_to_60) := lapply(.SD, replace_na_func), .SDcols = covars_subpop_5_to_60]
      
      # Multiply covariate values by fixed effect
      fe_9 <- as.matrix(data[, c(covars_subpop_5_to_60), with = F]) %*% B_9
      # Set fe 0 for ages outside of range
      fe_9 <- fe_9 * as.integer(data[, age %in% recode$age[age %in% c(5:60), age_recode]])
      fe <- fe + fe_9
    }
    
    fe <- as.matrix(fe)
    # Gets written over in array job by draw
    saveRDS(fe, paste0(output_dir_draws_est, "/fe_sims_", sex, "_", race, "_", m,".rds"))
  } else {
    #### Set up list for mean effects and point estimates
    point_ests <- list()
    mod <- mod[part == "random", -c("id", "part")]
    
    # calculate draws for the fixed portion of the model (same for all models)
    B_names <- names(mean)[grep("^B", names(mean))]
    B_names <- B_names[!(B_names %in% c("B2_BRFSS", "B2_Gallup", "B2_MarketScan", "B2_mdcr", "B2_HCUP"))] #### Accommodate source fixed effects
    B <- sims[names(mean) %in% B_names,]
    if (class(B) == "numeric") B <- matrix(B, nrow = 1) else B <- as.matrix(B)
    
    fe <- as.matrix(pred_frame[, c("int", covars, covars_as, covars_re), with = FALSE]) %*% B
    fe_mean <- as.matrix(pred_frame[, c("int", covars, covars_as, covars_re), with = FALSE]) %*% mod[param %in% B_names]$est
    fe_param <- mod[param %in% B_names]
    
    #### Set up fixed effects for model89 if by_source
    if (model %in% c("model89", "model91", "model94") & by_source) { # note that we do NOT want to predict out on the B2_Gallup in model 115
      B_names_source <- names(mean)[grep("^B", names(mean))]
      B_names_source <- B_names_source[(B_names_source %in% c("B2_BRFSS", "B2_Gallup", "B2_MarketScan", "B2_mdcr", "B2_HCUP"))] #### Get source fixed effects in model89
      B_source <- sims[names(mean) %in% B_names_source,]
      B_source <- rbind(B_source, c(rep(0, ncol(B_source))))
      if (class(B_source) == "numeric") B_source <- matrix(B_source, nrow = 1) else B_source <- as.matrix(B_source)
      fe_source <- cbind(as.data.table(B_source), "source" = c("BRFSS", "Gallup", "MarketScan", "mdcr", "HCUP", "NHANES"))
      fe_source <- merge(fe_source, recode$source[, -c("var")], by.x = "source", by.y = "source_index", all.x = TRUE)
      fe_source[, c("source", "source_index_recode") := list(source_index_recode, NULL)]
      setkeyv(fe_source, "source")
      fe <- fe + as.matrix(fe_source[J(pred_frame$source)][, simvars, with = FALSE])
    } else if (model %in% c("model116", "model117", "model118", "model120") & by_source) {
      B_names_source <- names(mean)[grep("^B", names(mean))]
      B_names_source <- B_names_source[(B_names_source %in% c("B2_Gallup"))]
      B_source <- sims[names(mean) %in% B_names_source,]
      B_source <- rbind(B_source, c(rep(0, length(draw_val))))
      if (class(B_source)[1] == "numeric") B_source <- matrix(B_source, nrow = 1) else B_source <- as.matrix(B_source)
      fe_source <- cbind(as.data.table(B_source), "source" = c("Gallup", "BRFSS"))
      fe_source <- merge(fe_source, recode$source[, -c("var")], by.x = "source", by.y = "source_index", all.x = TRUE)
      fe_source[, c("source", "source_index_recode") := list(source_index_recode, NULL)]
      setkeyv(fe_source, "source")
      fe <- fe + as.matrix(fe_source[J(pred_frame$source)][, simvars, with = FALSE])
      
      fe_mean <- fe_mean + as.matrix(pred_frame[, as.integer(source == recode$source[source_index == "Gallup", source_index_recode])]) %*% mod[param %in% c("B2_Gallup")]$est
      fe_param <- rbindlist(list(fe_param, mod[param %in% c("B2_Gallup")]), use.names = TRUE, fill = TRUE)
    }
  }
  
  # calculate draws for the random portion of the model (differs by model)
  # For re1: Draws of random effects (structured: RE-levels X number of draws)
  # For re1_mean and re1_param: Mean value of random effects.
  re1 <- data.table(as.matrix(sims[names(mean) == "re1",]))
  re1_mean <- mod[param == "re1", -c("se")] # For effects collapsed over age and time splines
  re1_param <- mod[param == "re1"] # For effects pre-collapse; reX_param only necessary for random effects splines; re_mean required for all random effects
  
  # calculate draws for the random portion of the model (differs by model)
  if (model %in% c("model47", "model48", "model49", "model50", "model51", "model81", "model101", "model102", "model52", "model53", "model55", "model56", "model57", "model58", "model64", "model65", "model66", "model68", "model69", "model70", "model73", "model80", "model116", "model105", "model99", "model108", "model100", "model106", "model107", "model103", "model104", "model82", "model83", "model86", "model89", "model94", "model91", "model88", "model87", "model84", "model85", "model78", "model79", "model93", "model95", "model96", "model113", "model117", "model118", "model120", "model119", "model115")) {
    ##### First deal with the age spline, which all of these models have in common
    s_year_original <- copy(s_year)
    
    if (model %in% c("model51", "model116", "model117", "model118", "model120", "model81", "model113", "model102", "model101", "model55", "model56", "model57", "model64", "model65", "model66", "model68", "model69", "model70", "model73", "model80", "model105", "model99", "model108", "model100", "model106", "model107", "model103", "model104", "model82", "model78", "model79", "model95", "model96", "model119", "model115")) {
      # get the combinations of age/time spline bases, areas, and races
      combos <- as.data.table(expand.grid(y_spline = seq(1, ncol(s_year)), a_spline = seq(1, ncol(s_age)), area = seq(0, num_j - 1L), race = 1:num_r - 1L))
      
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      
      re1 <- cbind(re1, combos)
      re1_mean <- cbind(re1_mean, combos)
      re1_param <- cbind(re1_param, combos)
      
      s_age[, age := .I - 1]
      s_year[, year := .I - 1]
      s_year <- melt.data.table(s_year, id.vars = "year", value.name = "y_spline_value", variable.name = "y_spline")
      s_age <- melt.data.table(s_age, id.vars = "age", value.name = "a_spline_value", variable.name = "a_spline")
      
      s_year[, y_spline := as.integer(as.character(y_spline))]
      s_age[, a_spline := as.integer(as.character(a_spline))]
      
      re1 <- merge(re1, s_year, by = "y_spline", allow.cartesian = TRUE)
      re1 <- merge(re1, s_age, by = "a_spline", allow.cartesian = TRUE)
      re1_mean <- merge(re1_mean, s_year, by = "y_spline", allow.cartesian = TRUE)
      re1_mean <- merge(re1_mean, s_age, by = "a_spline", allow.cartesian = TRUE)
      re1_param <- merge(re1_param, s_year, by = "y_spline", allow.cartesian = TRUE)
      re1_param <- merge(re1_param, s_age, by = "a_spline", allow.cartesian = TRUE)
      
      # simvars
      del_vars <- c("y_spline", "y_spline_value", "a_spline", "a_spline_value")
      
      re1 <- re1[, (simvars) := lapply(.SD, function(x) sum(x * y_spline_value * a_spline_value)), .SDcols = simvars, by = c("area", "race", "age", "year")]
      re1 <- re1[, (del_vars) := NULL]
      re1 <- unique(re1)
      setkeyv(re1, c("year", "age", "area", "race"))
      
      re1_mean <- re1_mean[, est := lapply(.SD, function(x) sum(x * y_spline_value * a_spline_value)), .SDcols = c("est"), by = c("area", "race", "age", "year")]
      re1_mean <- re1_mean[, (del_vars) := NULL]
      re1_mean <- unique(re1_mean)
      setkeyv(re1_mean, c("year", "age", "area", "race"))
    } else {
      # get the combinations of age spline bases, areas, and races
      combos <- as.data.table(expand.grid(a_spline = seq(1, ncol(s_age)), area = seq(0, num_j - 1L), race = 1:num_r - 1L))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      
      re1 <- cbind(re1, combos)
      s_age[, age := .I-1]
      s_age <- melt.data.table(s_age, id.vars = "age", value.name = "a_spline_value", variable.name = "a_spline")
      
      # simvars
      re1 <- re1[, (simvars) := lapply(.SD, function(x) sum(x * a_spline_value)), .SDcols = simvars, by = c("area", "race", "age")]
      del_vars <- c("a_spline", "a_spline_value")
      re1 <- re1[, (del_vars) := NULL]
      re1 <- unique(re1)
      setkeyv(re1, c("age", "area", "race"))
      }
    
    re2 <- data.table(as.matrix(sims[names(mean) == "re2",]))
    re2_mean <- mod[param == "re2",]
    
    ## Area effect
    if (model %in% c("model78")) {
      # get the combinations of areas and races
      combos <- as.data.table(expand.grid(area = seq(0, num_j - 1L), race = 1:num_r - 1L))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      
      re2 <- cbind(re2, combos)
      
      # re2[, area := 1:num_j - 1L]
      setkeyv(re2, c("area", "race"))
      
    } else {
      re2[, area := 1:num_j - 1L]
      re2_mean[, area := 1:num_j - 1L]
      
      setkeyv(re2, "area")
      setkeyv(re2_mean, "area")
    }
    
    ### Now, read in the 3rd random effect
    re3 <- data.table(as.matrix(sims[names(mean) == "re3",]))
    re3_mean <- mod[param == "re3",]
    
    if (model %in% c("model56", "model57", "model58", "model79", "model93", "model96")) {
      combos <- as.data.table(expand.grid(year = 0:(num_t - 1), age = 0:(num_a - 1), race = 0:(num_r - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re3 <- cbind(re3, combos)
      
      setkeyv(re3, c("year", "race", "age"))
      
    } else if (model %in% c("model82", "model83", "model86", "model89", "model94", "model91", "model87", "model88", "model84", "model85", "model101")) {
      re3 <- NULL
      
    } else if (model %in% c("model100", "model103")) {
      combos <- as.data.table(expand.grid(year = 0:(num_t - 1), race = 0:(num_r - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re3 <- cbind(re3, combos)
      
      
      setkeyv(re3, c("year", "race", "edu", "marital"))
      
    } else if (model %in% c("model104", "model106", "model107", "model118", "model120", "model119", "model115")) {
      combos <- as.data.table(expand.grid(age = 0:(num_a - 1), race = 0:(num_r - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re3 <- cbind(re3, combos)
      re3_mean <- cbind(re3_mean, combos)
      
      setkeyv(re3, c("age", "race", "edu", "marital"))
      setkeyv(re3_mean, c("age", "race", "edu", "marital"))
    } else if (model %in% c("model102")) {
      combos <- as.data.table(expand.grid(year = 0:(num_t - 1), age = 0:(num_a - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re3 <- cbind(re3, combos)
      
      setkeyv(re3, c("year", "age", "edu", "marital"))
      
    } else if (model %in% c("model105")) {
      combos <- as.data.table(expand.grid(age = 0:(num_a - 1), race = 0:(num_r - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re3 <- cbind(re3, combos)
      
      setkeyv(re3, c("race", "age", "edu", "marital"))
      
    } else if (model %in% c("model108")) {
      combos <- as.data.table(expand.grid(y_spline = seq(1, ncol(s_year)), age = 0:(num_a - 1), race = 0:(num_r - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re3 <- cbind(re3, combos)
      
      s_year <- copy(s_year_original)
      s_year[, year := .I - 1]
      s_year <- melt.data.table(s_year, id.vars = "year", value.name = "y_spline_value", variable.name = "y_spline")
      s_year[, y_spline := as.integer(as.character(y_spline))]
      
      re3 <- merge(re3, s_year, by = "y_spline", allow.cartesian = TRUE)
      
      re3 <- re3[, (simvars) := lapply(.SD, function(x) sum(x * y_spline_value)), .SDcols = simvars, by = c("race", "age", "year", "edu", "marital")]
      del_vars <- c("y_spline", "y_spline_value")
      re3 <- re3[, (del_vars) := NULL]
      re3 <- unique(re3)
      
      setkeyv(re3, c("year", "race", "age", "edu", "marital"))
      
    } else {
      combos <- as.data.table(expand.grid(year = 0:(num_t - 1), age = 0:(num_a - 1), race = 0:(num_r - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re3 <- cbind(re3, combos)
      re3_mean <- cbind(re3_mean, combos)
      
      setkeyv(re3, c("year", "race", "age", "edu", "marital"))
      setkeyv(re3_mean, c("year", "race", "age", "edu", "marital"))
    }
    
    ### Now, read in the 4th random effect
    re4 <- data.table(as.matrix(sims[names(mean) == "re4",]))
    re4_mean <- mod[param == "re4",]
    
    if (model %in% c("model57", "model79", "model99", "model108", "model100", "model106", "model107", "model103", "model104", "model93", "model118", "model119", "model115")) {
      #### No re4
    } else if (model %in% c("model96")) {
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re4 <- cbind(re4, combos)
      
      setkeyv(re4, c('race', 'source'))
    } else if (!(model %in% c("model68", "model70", "model69"))) {
      combos <- as.data.table(expand.grid(year = 0:(num_t - 1), age = 0:(num_a - 1), race = 0:(num_r - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re4 <- cbind(re4, combos)
      re4_mean <- cbind(re4_mean, combos)
      
      setkeyv(re4, c("year", "race", "age"))
      setkeyv(re4_mean, c("year", "race", "age"))
    }
    
    re5 <- data.table(as.matrix(sims[names(mean) == "re5",]))
    re5_mean <- mod[param == "re5",]
    
    ### Data source is the 5th random effect for model49
    if (model %in% c("model49", "model55", "model66", "model68", "model85", "model88")) {
      re5[, source := 1:num_d - 1L]
      setkeyv(re5, "source")
      
    } else if (model %in% c("model73", "model80", "model105", "model99", "model108", "model100", "model106", "model107", "model78") | (model %in% c("model82", "model83", "model86", "model84") & !is.null(gold_standard_source))) {
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      re5_mean <- cbind(re5_mean, combos)
      
      setkeyv(re5, c("race", "source"))
      setkeyv(re5_mean, c("race", "source"))
      
      
    } else if (model %in% c("model115")){
      if(is.null(gold_standard_source)) stop("Gold-standard must be specified for model 115")
      re5[, source_race := 1:num_dr - 1L]
      re5_mean[, source_race := 1:num_dr - 1L]
      
      setkeyv(re5, "source_race")
      setkeyv(re5_mean, "source_race")
    } else if (model %in% c("model82", "model83", "model86", "model84") & is.null(gold_standard_source)) {
      out <- readRDS(paste0(output_dir, "/model_fit_", sex, ".rds"))
      log_sigma <- as.data.table(summary(out))[rownames(summary(out)) == "re5_log_sigma", "Estimate"]
      
      re5 <- matrix(rnorm(draw_width * nrow(re5_ests), mean = 0, sd = as.numeric(exp(log_sigma))), ncol = draw_width)
      
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      
      
      setkeyv(re5, c("race", "source"))
      
    } else if (model %in% c("model94") & is.null(gold_standard_source) & !by_source) {
      re5_ests <- data.table(as.matrix(sims[names(mean) == "re5",]))
      out <- readRDS(paste0(output_dir, "/model_fit_", sex, ".rds"))
      log_sigma <- as.data.table(summary(out))[rownames(summary(out)) == "re5_log_sigma", "Estimate"]
      
      re5 <- matrix(rnorm(draw_width * nrow(re5_ests), mean = 0, sd = as.numeric(exp(log_sigma))), ncol = draw_width)
      
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      
      re5[source %in% recode$source[source_index %in% c("MarketScan", "NHANES"), source_index_recode], (simvars) := 0] # Drop re5 for MarketScan and NHANES
      
      setkeyv(re5, c("race", "source"))
      
    } else if (model %in% c("model89", "model94", "model91") & !is.null(gold_standard_source) & !by_source) {
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      
      re5[source %in% recode$source[source_index %in% c("MarketScan"), source_index_recode], (simvars) := 0] # Drop re5 for MarketScan
      
      setkeyv(re5, c("race", "source"))
      
    } else if (model %in% c("model89", "model94", "model91") & by_source) { # Predict by source
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      re5 <- cbind(re5_ests, combos)
      
      #### Set re value to 0 for gold standard source (not evaluated in likelihood)
      re5[source %in% recode$source[source_index %in% c("MarketScan"), source_index_recode], (simvars) := 0] # Drop re5 for MarketScan
      
      setkeyv(re5, c("race", "source"))
      
    } else if ((model %in% c("model87", "model95") & !is.null(gold_standard_source))) {
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), age = 0:(num_a - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      
      setkeyv(re5, c("race", "age", "source"))
      
    } else if (model %in% c("model87") & is.null(gold_standard_source)) {
      re5_ests <- data.table(as.matrix(sims[names(mean) == "re5",]))
      out <- readRDS(paste0(output_dir, "/model_fit_", sex, ".rds"))
      log_sigma <- as.data.table(summary(out))[rownames(summary(out)) == "re5_log_sigma", "Estimate"]
      
      re5 <- matrix(rnorm(draw_width * nrow(re5_ests), mean = 0, sd = as.numeric(exp(log_sigma))), ncol = draw_width)
      
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), age = 0:(num_a - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      
      setkeyv(re5, c("race", "source"))
      
    } else if (model %in% c("model95")) {
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), age = 0:(num_a - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      
      setkeyv(re5, c("race", "age", "source"))
    } else if (model %in% c("model116") & !is.null(gold_standard_source) & !by_source) {
      re5 <- data.table(as.matrix(sims[names(mean) == "re5",]))
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      
    } else if (model %in% c("model116") & !is.null(gold_standard_source) & !by_source) {
      re5 <- data.table(as.matrix(sims[names(mean) == "re5",]))
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      
      re5[source %in% recode$source[source_index %in% c(gold_standard_source), source_index_recode], (simvars) := 0] # Drop re5 for gold standard
      
      setkeyv(re5, c("race", "source"))
      
    } else if (model %in% c("model116") & is.null(gold_standard_source) & by_source) {
      re5 <- data.table(as.matrix(sims[names(mean) == "re5",]))
      combos <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      re5_mean <- cbind(re5_mean, combos)
      
      setkeyv(re5, c("race", "source"))
      setkeyv(re5_mean, c("race", "source"))
    } else if (model %in% c("model113")) {
      re5 <- data.table(as.matrix(sims[names(mean) == "re5",]))
      combos <- as.data.table(expand.grid(state = 0:(num_w - 1), race = 0:(num_r - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re5 <- cbind(re5, combos)
      re5_mean <- cbind(re5_mean, combos)
      
      setkeyv(re5, c("race", "state", "edu", "marital"))
      setkeyv(re5_mean, c("race", "state", "edu", "marital"))
    } else if (model %in% c("model117", "model118")) {
      if (is.null(gold_standard_source)) stop ("Gold-standard must be specified for this model.")
      
      recode$source_race[, source := substr(source_race, 0, gregexpr(pattern = '_', source_race)[[2]][[1]] - 1L)]
      recode$source_race[, race := as.integer(substr(source_race, gregexpr(pattern = '_', source_race)[[2]][[1]] + 1L, nchar(source_race)))]
      recode$source_race <- merge(recode$source_race, recode$race[, c("race", "race_recode")], by = "race")
      recode$source_race <- merge(recode$source_race, recode$source[, c("source_index", "source_index_recode")], by.x = "source", by.y = "source_index")
      
      combos <- recode$source_race[, c("source_race_recode", "source_index_recode", "race_recode")]
      setnames(combos, c("source_race_recode", "source_index_recode", "race_recode"), c("source_race", "source", "race"))
      
      re5[, source_race := 1:num_dr - 1L]
      re5_mean[, source_race := 1:num_dr - 1L]
      
      re5 <- merge(re5, combos, by = "source_race")
      re5_mean <- merge(re5_mean, combos, by = "source_race")
      
      combos2 <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L)))
      re5 <- merge(re5, combos2, by = c("race", "source"), all = TRUE)
      re5_mean <- merge(re5_mean, combos2, by = c("race", "source"), all = TRUE)
      
      re5[is.na(re5)] <- 0
      re5_mean[is.na(re5_mean)] <- 0
      
      setkeyv(re5, c("source", "race"))
      setkeyv(re5_mean, c("source", "race"))
    } else if (model %in% c("model120")) {
      if (is.null(gold_standard_source)) stop ("Gold-standard must be specified for this model.")
      
      recode$source_race <- merge(recode$source_race, recode$race[, c("race", "race_recode")], by = "race")
      recode$source_race <- merge(recode$source_race, recode$source[, c("source_index", "source_index_recode")], by.x = "source", by.y = "source_index")
      setkey(recode$source_race, "nrow")
      
      combos <- recode$source_race[, c("nrow", "source_race_recode", "source_index_recode", "race_recode")]
      setnames(combos, c("source_race_recode", "source_index_recode", "race_recode"), c("source_race", "source", "race"))
      
      combos <- merge(combos, as.data.table(expand.grid(source_race = 0:(num_dr - 1L), age = 0:(num_a - 1L))), by = "source_race")
      setkeyv(combos, c("nrow", "age", "race"))
      
      re5 <- cbind(re5, combos)
      re5_mean <- cbind(re5_mean, combos)
      
      combos2 <- as.data.table(expand.grid(race = 0:(num_r - 1L), source = 0:(num_d - 1L), age = 0:(num_a - 1L)))
      re5 <- merge(re5, combos2, by = c("race", "source", "age"), all = TRUE)
      re5_mean <- merge(re5_mean, combos2, by = c("race", "source", "age"), all = TRUE)
      
      re5[is.na(re5)] <- 0
      re5_mean[is.na(re5_mean)] <- 0
      
      setkeyv(re5, c("source", "age", "race"))
      setkeyv(re5_mean, c("source", "age", "race"))
    }
    
    ### Phone is the 5th random effect for model65
    if (model %in% c("model65", "model69")) {
      re5 <- data.table(as.matrix(sims[names(mean) == "re5",]))
      re5[, phone := 1:num_f - 1L]
      setkeyv(re5, "phone")
      
    }
    
    re6 <- data.table(as.matrix(sims[names(mean) == "re6",]))
    re6_mean <- mod[param == "re6",]
    re7_mean <- mod[param == "re7",]
    re8_mean <- mod[param == "re8",]
    
    ### Phone is the 6th random effect for model66
    if (model %in% c("model66", "model68")) {
      re6[, phone := 1:num_f - 1L]
      setkeyv(re6, "phone")
      
    }
    
    ### State is the 6th random effect for model91
    if (model %in% c("model91")) {
      re6[, state := 1:num_w - 1L]
      setkeyv(re6, "state")
    } else if (model %in% c("model116", "model117")) {
      re6 <- data.table(as.matrix(sims[names(mean) == "re6",]))
      combos <- as.data.table(expand.grid(state = 0:(num_w - 1), race = 0:(num_r - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re6 <- cbind(re6, combos)
      re6_mean <- cbind(re6_mean, combos)
      
      setkeyv(re6, c("race", "state", "edu", "marital"))
      setkeyv(re6_mean, c("race", "state", "edu", "marital"))
    }
    
    ### Year, age, and race are the 6th, 7th, and 8th random effects for model91, respectively
    if (model %in% c("model99", "model108", "model100", "model106", "model107", "model103", "model104", "model118", "model119", "model120", "model115")) {
      re6 <- data.table(as.matrix(sims[names(mean) == "re6",]))
      re6_mean <- mod[param == "re6",]
      re6[, year := 1:num_t - 1L]
      re6_mean[, year := 1:num_t - 1L]
      setkeyv(re6, "year")
      setkeyv(re6_mean, "year")
      
      re7 <- data.table(as.matrix(sims[names(mean) == "re7",]))
      re7_mean <- mod[param == "re7",]
      re7[, age := 1:num_a - 1L]
      re7_mean[, age := 1:num_a - 1L]
      setkeyv(re7, "age")
      setkeyv(re7_mean, "age")
      
      re8 <- data.table(as.matrix(sims[names(mean) == "re8",]))
      re8_mean <- mod[param == "re8",]
      re8[, race := 1:num_r - 1L]
      re8_mean[, race := 1:num_r - 1L]
      setkeyv(re8, "race")
      setkeyv(re8_mean, "race")
    }
    
    ### Year-race-edu-marital is the 9th random effect for model107
    if (model %in% c("model107", "model118", "model119", "model120", "model115")) {
      re9 <- data.table(as.matrix(sims[names(mean) == "re9",]))
      re9_mean <- mod[param == "re9",]
      
      combos <- as.data.table(expand.grid(year = 0:(num_t - 1), race = 0:(num_r - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re9 <- cbind(re9, combos)
      re9_mean <- cbind(re9_mean, combos)
      
      setkeyv(re9, c("year", "race", "edu", "marital"))
      setkeyv(re9_mean, c("year", "race", "edu", "marital"))
    }
    
    ### State-race-edu-marital is the 19th random effect for model118
    if (model %in% c("model118", "model120")) {
      re10 <- data.table(as.matrix(sims[names(mean) == "re10",]))
      re10_mean <- mod[param == "re10",]
      
      combos <- as.data.table(expand.grid(state = 0:(num_w - 1), race = 0:(num_r - 1), edu = 0:(num_e - 1), marital = 0:(num_m - 1)))
      if (!race_together) {
        combos[, race := get("race", .GlobalEnv)]
      }
      re10 <- cbind(re10, combos)
      re10_mean <- cbind(re10_mean, combos)
      
      setkeyv(re10, c("race", "state", "edu", "marital"))
      setkeyv(re10_mean, c("race", "state", "edu", "marital"))
    }
    
    # Calculate linear predictor ----------------------------------------------
    if (model %in% c("model51", "model81", "model64")) {
      if (any(ages >= 20)) { # If the age range spans 20
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                          as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
        
        re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                               as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                               as.matrix(re3_mean[pred_frame[, list(year, race, age, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                               as.matrix(re4_mean[pred_frame[, list(year, race, age)], est]))
        re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re4" = re4_mean)
      } else { # Otherwise don't include re3
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re4[pred_frame[, list(year, age, race)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model113")) {
      if (any(ages >= 20)) { # If the age range spans 20
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                          as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                          as.matrix(re5[pred_frame[, list(race, state, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        
        re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                               as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                               as.matrix(re3_mean[pred_frame[, list(year, race, age, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                               as.matrix(re4_mean[pred_frame[, list(year, race, age)], est]) +
                               as.matrix(re5_mean[pred_frame[, list(race, state, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re4" = re4_mean, "re5" = re5_mean)
      } else { # Otherwise don't include re3 and re5
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model102")) {
      if (any(ages >= 20)) { # If the age range spans 20
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                          as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
      } else { # Otherwise don't include re3
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model101")) {
      re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                        as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
    } else if (model %in% c("model65")) {
      if (any(ages >= 20)) { # If the age range spans 20
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                          as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                          as.matrix(re5[pred_frame[, list(phone)], simvars, with = FALSE]))
      } else { # Otherwise don't include re3
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                          as.matrix(re5[pred_frame[, list(phone)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model69")) {
      if (any(ages >= 20)) { # If the age range spans 20
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                          as.matrix(re5[pred_frame[, list(phone)], simvars, with = FALSE]))
      } else { # Otherwise don't include re3
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re5[pred_frame[, list(phone)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model70")) {
      if (any(ages >= 20)) { # If the age range spans 20
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
      } else { # Otherwise don't include re3
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model52", "model53")) {
      if (any(ages >= 20)) { # If the age range spans 20
        re <- as.matrix(as.matrix(re1[pred_frame[, list(age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                          as.matrix(re4[pred_frame[, list(state, year, age, race)], simvars, with = FALSE]))
      } else { # Otherwise don't include re3
        re <- as.matrix(as.matrix(re1[pred_frame[, list(age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re4[pred_frame[, list(state, year, age, race)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model55")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source)) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(source)], simvars, with = FALSE]))
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source)) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(source)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model73", "model80")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
          re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                                 as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                                 as.matrix(re3_mean[pred_frame[, list(year, race, age, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                                 as.matrix(re4_mean[pred_frame[, list(year, race, age)], est]))
          re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re4" = re4_mean)
          
          
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
          re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                                 as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                                 as.matrix(re3_mean[pred_frame[, list(year, race, age, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                                 as.matrix(re4_mean[pred_frame[, list(year, race, age)], est]) + 
                                 as.matrix(re5_mean[pred_frame[, list(race, source)], est]))
          re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re4" = re4_mean, "re5" = re5_mean)
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model116")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(race, state, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(race, state, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
          re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                                 as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                                 as.matrix(re3_mean[pred_frame[, list(year, race, age, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                                 as.matrix(re4_mean[pred_frame[, list(year, race, age)], est]) +
                                 as.matrix(re5_mean[pred_frame[, list(race, source)], est]) +
                                 as.matrix(re6_mean[pred_frame[, list(race, state, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
          re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re4" = re4_mean, "re5" = re5_mean, "re6" = re6_mean)
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model117")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(race, state, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(race, state, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
          
          re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                                 as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                                 as.matrix(re3_mean[pred_frame[, list(year, race, age, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                                 as.matrix(re4_mean[pred_frame[, list(year, race, age)], est]) +
                                 as.matrix(re6_mean[pred_frame[, list(race, state, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
          re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re4" = re4_mean, "re5" = re5_mean, "re6" = re6_mean)
        }
      }
    } else if (model %in% c("model105")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model99", "model108")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model100")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model106")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model107")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                            as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) + 
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                            as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model118")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                            as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re10[pred_frame[, list(race, state, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re5[pred_frame[, list(source, race)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                            as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re10[pred_frame[, list(race, state, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
          
          re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                                 as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                                 as.matrix(re3_mean[pred_frame[, list(age, race, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                                 as.matrix(re5_mean[pred_frame[, list(source, race)], est]) +
                                 as.matrix(re6_mean[pred_frame[, list(year)], est]) +
                                 as.matrix(re7_mean[pred_frame[, list(age)], est]) +
                                 as.matrix(re8_mean[pred_frame[, list(race)], est]) +
                                 as.matrix(re9_mean[pred_frame[, list(year, race, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                                 as.matrix(re10_mean[pred_frame[, list(race, state, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
          
          re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re5" = re5_mean, "re6" = re6_mean, "re7" = re7_mean, "re8" = re8_mean, "re9" = re9_mean, "re10" = re10_mean)
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model120")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                            as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re10[pred_frame[, list(race, state, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re5[pred_frame[, list(source, age, race)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                            as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re10[pred_frame[, list(race, state, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
          
          re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                                 as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                                 as.matrix(re3_mean[pred_frame[, list(age, race, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                                 as.matrix(re5_mean[pred_frame[, list(source, age, race)], est]) +
                                 as.matrix(re6_mean[pred_frame[, list(year)], est]) +
                                 as.matrix(re7_mean[pred_frame[, list(age)], est]) +
                                 as.matrix(re8_mean[pred_frame[, list(race)], est]) +
                                 as.matrix(re9_mean[pred_frame[, list(year, race, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                                 as.matrix(re10_mean[pred_frame[, list(race, state, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
          
          re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re5" = re5_mean, "re6" = re6_mean, "re7" = re7_mean, "re8" = re8_mean, "re9" = re9_mean, "re10" = re10_mean)
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model119")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source) & !by_source) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                            as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))# +
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                            as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                            as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                            as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))# +
          
          re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                                 as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                                 as.matrix(re3_mean[pred_frame[, list(age, race, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                                 as.matrix(re6_mean[pred_frame[, list(year)], est]) +
                                 as.matrix(re7_mean[pred_frame[, list(age)], est]) +
                                 as.matrix(re8_mean[pred_frame[, list(race)], est]) +
                                 as.matrix(re9_mean[pred_frame[, list(year, race, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))# +
          
          re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re6" = re6_mean, "re7" = re7_mean, "re8" = re8_mean, "re9" = re9_mean)
        }
      }
    } else if (model %in% c("model115")){
      if (is.null(gold_standard_source)) stop("Model 115 not tested when gold standard is null")
      if (any(ages >= 20)) { # If the age range spans 20
        
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                          as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                          as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                          as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                          as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        
        re_mean <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                               as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                               as.matrix(re3_mean[pred_frame[, list(age, race, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                               as.matrix(re6_mean[pred_frame[, list(year)], est]) +
                               as.matrix(re7_mean[pred_frame[, list(age)], est]) +
                               as.matrix(re8_mean[pred_frame[, list(race)], est]) +
                               as.matrix(re9_mean[pred_frame[, list(year, race, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        
        re_param <- list("B" = fe_param, "re1" = re1_param, "re2" = re2_mean, "re3" = re3_mean, "re5" = re5_mean, "re6" = re6_mean, "re7" = re7_mean, "re8" = re8_mean, "re9" = re9_mean)
        
      } else { # Otherwise don't include re3
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                          as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                          as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]) +
                          as.matrix(re9[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
        
        re <- as.matrix(as.matrix(re1_mean[pred_frame[, list(year, age, area, race)], est]) +
                          as.matrix(re2_mean[pred_frame[, list(area)], est]) +
                          as.matrix(re6_mean[pred_frame[, list(year)], simvars, est]) +
                          as.matrix(re7_mean[pred_frame[, list(age)], simvars, est]) +
                          as.matrix(re8_mean[pred_frame[, list(race)], simvars, est]) +
                          as.matrix(re9_mean[pred_frame[, list(year, race, edu, marital)], est] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])))
      }
    } else if (model %in% c("model103")) {
      if (any(ages >= 20)) { # If the age range spans 20
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                          as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                          as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                          as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        
      } else { # Otherwise don't include re3
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                          as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                          as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model104")) {
      if (any(ages >= 20)) { # If the age range spans 20
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(age, race, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                          as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                          as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                          as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
        
      } else { # Otherwise don't include re3
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re6[pred_frame[, list(year)], simvars, with = FALSE]) +
                          as.matrix(re7[pred_frame[, list(age)], simvars, with = FALSE]) +
                          as.matrix(re8[pred_frame[, list(race)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model82")) {
      re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                        as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                        as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
      # }
    } else if (model %in% c("model83", "model86")) {
      re <- as.matrix(as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                        as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
    } else if (model %in% c("model89", "model94")) {
      re <- as.matrix(as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                        as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
    } else if (model %in% c("model91")) {
      re <- as.matrix(as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                        as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]) +
                        as.matrix(re6[pred_frame[, list(state)], simvars, with = FALSE]))
    } else if (model %in% c("model87")) {
      re <- as.matrix(as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                        as.matrix(re5[pred_frame[, list(race, age, source)], simvars, with = FALSE]))
    } else if (model %in% c("model84")) {
      re <- as.matrix(as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                        as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
    } else if (model %in% c("model85")) {
      if (is.null(gold_standard_source) & !by_source) {
        re <- as.matrix(as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
      } else {
        re <- as.matrix(as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                          as.matrix(re5[pred_frame[, list(source)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model88")) {
      re <- as.matrix(as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                        as.matrix(re5[pred_frame[, list(source)], simvars, with = FALSE]))
    } else if (model %in% c("model78")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source)) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area, race)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area, race)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source)) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area, race)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area, race)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(race, source)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model66")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source)) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(phone)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(phone)], simvars, with = FALSE]))
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source)) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(phone)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(phone)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model68")) {
      if (any(ages >= 20)) { # If the age range spans 20
        if (is.null(gold_standard_source)) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re6[pred_frame[, list(phone)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]])) +
                            as.matrix(re5[pred_frame[, list(source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(phone)], simvars, with = FALSE]))
        }
      } else { # Otherwise don't include re3
        if (is.null(gold_standard_source)) {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(phone)], simvars, with = FALSE]))
        } else {
          re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                            as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                            as.matrix(re5[pred_frame[, list(source)], simvars, with = FALSE]) +
                            as.matrix(re6[pred_frame[, list(phone)], simvars, with = FALSE]))
        }
      }
    } else if (model %in% c("model56")) {
      if (is.null(gold_standard_source)) {
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
      } else {
        re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                          as.matrix(re4[pred_frame[, list(source)], simvars, with = FALSE]))
      }
    } else if (model %in% c("model96")) {
      re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                        as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re3[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                        as.matrix(re4[pred_frame[, list(race, source)], simvars, with = FALSE]))
    } else if (model %in% c("model57", "model79")) {
      re <- as.matrix(as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re3[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
    } else if (model %in% c("model93")) {
      re <- as.matrix(as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re3[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
    } else if (model %in% c("model58")) {
      if (is.null(gold_standard_source)) {
        re <- as.matrix(as.matrix(re1[pred_frame[, list(age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
      } else {
        re <- as.matrix(as.matrix(re1[pred_frame[, list(age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re3[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                          as.matrix(re4[pred_frame[, list(source)], simvars, with = FALSE]))
      }
    } else if (model %in% c('model95')) {
      re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age, area, race)], simvars, with = FALSE]) +
                        as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                        as.matrix(re3[pred_frame[, list(year, race, age, edu, marital)], simvars, with = FALSE]) +
                        as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                        as.matrix(re5[pred_frame[, list(race, age, source)], simvars, with = FALSE]))
    } else { # Otherwise don't include re3
      if (is.null(gold_standard_source)) {
        re <- as.matrix(as.matrix(re1[pred_frame[, list(age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]) +
                          as.matrix(re5[pred_frame[, list(source)], simvars, with = FALSE]))
      } else {
        re <- as.matrix(as.matrix(re1[pred_frame[, list(age, area, race)], simvars, with = FALSE]) +
                          as.matrix(re2[pred_frame[, list(area)], simvars, with = FALSE]) +
                          as.matrix(re4[pred_frame[, list(year, race, age)], simvars, with = FALSE]))
      }
    }
  } else if (grepl("state_model", model)) {
    ## State effect
    if (model %in% c("state_model21", "state_model28")) {
      re2 <- data.table(as.matrix(sims[names(mean) == "re2",]))
      re2[, state := 1:num_k - 1L]
      setkeyv(re2, "state")
    }
    
    ## Age-year random intercept (in most models)
    if (!(model %in% c("state_model21", "state_model22"))){
      combos <- as.data.table(expand.grid(year = 0:(num_t - 1), age = 0:(num_a - 1)))
      re1 <- data.table(as.matrix(sims[names(mean) == "re1",]))
      re1 <- cbind(re1, combos)
      setkeyv(re1, c("year", "age"))
    }
    
    ## Age-year-state random intercept
    if (model %in% c("state_model22")) {
      combos <- as.data.table(expand.grid(year = 0:(num_t - 1), age = 0:(num_a - 1), state = 0:(num_k - 1)))
      re1 <- data.table(as.matrix(sims[names(mean) == "re1",]))
      re1 <- cbind(re1, combos)
      setkeyv(re1, c("year", "age", "state"))
    }
    
    if (model %in% c("state_model21")) {
      re <- as.matrix(as.matrix(re1[pred_frame[, list(year, age)], simvars, with = FALSE]) + 
                        as.matrix(re2[data[, list(state)], simvars, with = FALSE]))
      
    } else if (model %in% c("state_model22")) {
      re <- as.matrix(re1[pred_frame[, list(year, age, state)], simvars, with = FALSE])
    } else {
      re <- as.matrix(re1[pred_frame[, list(year, age)], simvars, with = FALSE])
    }
    
    if (exists("covars_subpop")) {
      if (length(covars_subpop) != 0) {
        covar_subpop_random_effects <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects) / length(covars_subpop)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows is {paste(covar_subpop_random_effect_rows, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect <- covar_subpop_random_effects[covar_subpop_random_effect_rows,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect)} rows"))
          }
          
          # include age for subsetting with pred_frame to ensure correct order
          covar_subpop_random_effect[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect, "age")
          
          # pull out the current covariate
          # vector
          covar_value <- data[, get(covars_subpop[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_value * covar_subpop_random_effect[pred_frame[, list(age)], simvars, with = F])
          print(glue::glue("Done with loop {i}."))
        }
      }
    }
    
    if (model %in% c("state_model26", "state_model27", "state_model28")) {
      covar_subpop_random_effects_race <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_race",]))
      
      # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
      for (i in c(1:length(covars_subpop))) {
        print(glue::glue("Working on covariate number {i}: {covars_subpop[i]}"))
        
        # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
        chunk_size <- nrow(covar_subpop_random_effects_race) / length(covars_subpop)
        print(glue::glue("chunk_size = {chunk_size}"))
        
        # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
        end_row <- chunk_size * i
        
        # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
        begin_row <- end_row - chunk_size + 1
        print(glue::glue("begin_row is {begin_row}"))
        print(glue::glue("end_row is {end_row}"))
        
        covar_subpop_random_effect_race_rows <- c((begin_row):(end_row))
        print(glue::glue("covar_subpop_random_effect_race_rows is {paste(covar_subpop_random_effect_race_rows, collapse=',')}"))
        
        # check that the number of rows is correct
        if (length(covar_subpop_random_effect_race_rows) != chunk_size) {
          stop(glue::glue("covar_subpop_random_effect_race_rows should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_race_rows)}"))
        }
        
        # subset / pull out the rows that are for this covariate
        covar_subpop_random_effect_race <- covar_subpop_random_effects_race[covar_subpop_random_effect_race_rows,]
        
        # check that the number of rows is correct
        if (nrow(covar_subpop_random_effect_race) != chunk_size) {
          stop(glue::glue("covar_subpop_random_effect_race should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_race)} rows"))
        }
        
        # include age for subsetting with pred_frame to ensure correct order
        covar_subpop_random_effect_race[, race := 0:(num_r - 1)]
        setkeyv(covar_subpop_random_effect_race, "race")
        
        # pull out the current covariate
        # vector
        covar_value_race <- data[, get(covars_subpop[i])]
        
        # Add these race covariate slopes to the other random effects
        print("adding to re...")
        re <- re + (covar_value_race * covar_subpop_random_effect_race[pred_frame[, list(race)], simvars, with = F])
        print(glue::glue("Done with loop {i}."))
      } 
    }
    
    if (exists("covars_subpop_20plus")) {
      if (length(covars_subpop_20plus) != 0) { 
        covar_subpop_random_effects_20plus <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_20plus",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_20plus))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_20plus[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_20plus) / length(covars_subpop_20plus)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_20plus <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_20plus is {paste(covar_subpop_random_effect_rows_20plus, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_20plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_20plus should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_20plus)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_20plus <- covar_subpop_random_effects_20plus[covar_subpop_random_effect_rows_20plus,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_20plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_20plus should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_20plus)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_20plus[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect_20plus, "age")
          
          # pull out the current covariate
          covar_20plus_value <- data[, get(covars_subpop_20plus[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_20plus_value * covar_subpop_random_effect_20plus[pred_frame[, list(age)], simvars, with = F] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]]))
          print(glue::glue("Done with loop {i}."))
        }
      }
    }
    
    if (model %in% c("state_model26")) {
      covar_subpop_random_effects_20plus_race <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_20plus_race",]))
      
      # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
      for (i in c(1:length(covars_subpop_20plus))) {
        print(glue::glue("Working on covariate number {i}: {covars_subpop_20plus[i]}"))
        
        # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
        chunk_size <- nrow(covar_subpop_random_effects_20plus_race) / length(covars_subpop_20plus)
        print(glue::glue("chunk_size = {chunk_size}"))
        
        # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
        end_row <- chunk_size * i
        
        # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
        begin_row <- end_row - chunk_size + 1
        print(glue::glue("begin_row is {begin_row}"))
        print(glue::glue("end_row is {end_row}"))
        
        covar_subpop_random_effect_rows_20plus_race <- c((begin_row):(end_row))
        print(glue::glue("covar_subpop_random_effect_rows_20plus_race is {paste(covar_subpop_random_effect_rows_20plus_race, collapse=',')}"))
        
        # check that the number of rows is correct
        if (length(covar_subpop_random_effect_rows_20plus_race) != chunk_size) {
          stop(glue::glue("covar_subpop_random_effect_rows_20plus_race should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_20plus_race)}"))
        }
        
        # subset / pull out the rows that are for this covariate
        covar_subpop_random_effect_20plus_race <- covar_subpop_random_effects_20plus_race[covar_subpop_random_effect_rows_20plus_race,]
        
        # check that the number of rows is correct
        if (nrow(covar_subpop_random_effect_20plus_race) != chunk_size) {
          stop(glue::glue("covar_subpop_random_effect_20plus_race should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_20plus_race)} rows"))
        }
        
        # include age for merging
        covar_subpop_random_effect_20plus_race[, race := 0:(num_r - 1)]
        setkeyv(covar_subpop_random_effect_20plus_race, "race")
        
        # pull out the current covariate
        covar_20plus_race_value <- data[, get(covars_subpop_20plus[i])]
        
        # Add these age covariate slopes to the other random effects
        print("adding to re...")
        re <- re + (covar_20plus_race_value * covar_subpop_random_effect_20plus_race[pred_frame[, list(race)], simvars, with = F] * as.integer(pred_frame[, age >= recode$age[age == 20, age_recode]]))
        print(glue::glue("Done with loop {i}."))
      } 
    }
    
    if (exists("covars_subpop_60under") & !is.null(covars_subpop_60under)) {
      if (length(covars_subpop_60under) != 0) {
        covar_subpop_random_effects_60under <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_60under",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_60under))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_60under[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_60under) / length(covars_subpop_60under)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_60under <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_60under is {paste(covar_subpop_random_effect_rows_60under, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_60under) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_60under should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_60under)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_60under <- covar_subpop_random_effects_60under[covar_subpop_random_effect_rows_60under,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_60under) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_60under should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_60under)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_60under[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect_60under, "age")
          
          # pull out the current covariate
          covar_60under_value <- data[, get(covars_subpop_60under[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_60under_value * covar_subpop_random_effect_60under[pred_frame[, list(age)], simvars, with = F] * as.integer(pred_frame[, age <= recode$age[age == 60, age_recode]]))
          print(glue::glue("Done with loop {i}."))
        }
      }
      
      if (model %in% c("state_model26", "state_model27", "state_model28")) {
        covar_subpop_random_effects_60under_race <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_60under_race",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_60under))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_60under[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_60under_race) / length(covars_subpop_60under)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_60under_race <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_60under_race is {paste(covar_subpop_random_effect_rows_60under_race, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_60under_race) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_60under_race should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_60under_race)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_60under_race <- covar_subpop_random_effects_60under_race[covar_subpop_random_effect_rows_60under_race,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_60under_race) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_60under_race should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_60under_race)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_60under_race[, race := 0:(num_r - 1)]
          setkeyv(covar_subpop_random_effect_60under_race, "race")
          
          # pull out the current covariate
          covar_random_effect_60under_race <- data[, get(covars_subpop_60under[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_random_effect_60under_race * covar_subpop_random_effect_60under_race[pred_frame[, list(race)], simvars, with = F] * as.integer(pred_frame[, age <= recode$age[age == 60, age_recode]]))
          print(glue::glue("Done with loop {i}."))
        }
      }
    }
    
    if (exists("covars_subpop_5plus")) {
      if (length(covars_subpop_5plus) != 0) {
        covar_subpop_random_effects_5plus <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_5plus",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_5plus))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_5plus[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_5plus) / length(covars_subpop_5plus)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_5plus <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_5plus is {paste(covar_subpop_random_effect_rows_5plus, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_5plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_5plus should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_5plus)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_5plus <- covar_subpop_random_effects_5plus[covar_subpop_random_effect_rows_5plus,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_5plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_5plus should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_5plus)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_5plus[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect_5plus, "age")
          
          # pull out the current covariate
          covar_5plus_value <- data[, get(covars_subpop_5plus[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_5plus_value * covar_subpop_random_effect_5plus[pred_frame[, list(age)], simvars, with = F] * as.integer(pred_frame[, age >= recode$age[age == 5, age_recode]]))
          print(glue::glue("Done with loop {i}."))
        } 
      }
    }
    
    if (exists("covars_subpop_15plus")) {
      if (length(covars_subpop_15plus) != 0) {
        covar_subpop_random_effects_15plus <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_15plus",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_15plus))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_15plus[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_15plus) / length(covars_subpop_15plus)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_15plus <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_15plus is {paste(covar_subpop_random_effect_rows_15plus, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_15plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_15plus should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_15plus)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_15plus <- covar_subpop_random_effects_15plus[covar_subpop_random_effect_rows_15plus,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_15plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_15plus should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_15plus)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_15plus[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect_15plus, "age")
          
          # pull out the current covariate
          covar_15plus_value <- data[, get(covars_subpop_15plus[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_15plus_value * covar_subpop_random_effect_15plus[pred_frame[, list(age)], simvars, with = F] * as.integer(pred_frame[, age >= recode$age[age == 15, age_recode]]))
          print(glue::glue("Done with loop {i}."))
        }
      }
      
      if (model %in% c("state_model26")) {
        covar_subpop_random_effects_15plus_race <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_15plus_race",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_15plus))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_15plus[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_15plus_race) / length(covars_subpop_15plus)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_15plus_race <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_15plus_race is {paste(covar_subpop_random_effect_rows_15plus_race, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_15plus_race) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_15plus_race should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_15plus_race)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_15plus_race <- covar_subpop_random_effects_15plus_race[covar_subpop_random_effect_rows_15plus_race,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_15plus_race) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_15plus_race should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_15plus_race)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_15plus_race[, race := 0:(num_r - 1)]
          setkeyv(covar_subpop_random_effect_15plus_race, "race")
          
          # pull out the current covariate
          covar_random_effect_15plus_race <- data[, get(covars_subpop_15plus[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_random_effect_15plus_race * covar_subpop_random_effect_15plus_race[pred_frame[, list(race)], simvars, with = F] * as.integer(pred_frame[, age >= recode$age[age == 15, age_recode]]))
          print(glue::glue("Done with loop {i}."))
        }
      }
    }
    
    if (exists("covars_subpop_1plus")) {
      if (length(covars_subpop_1plus) != 0) {
        covar_subpop_random_effects_1plus <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_1plus",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_1plus))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_1plus[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_1plus) / length(covars_subpop_1plus)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_1plus <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_1plus is {paste(covar_subpop_random_effect_rows_1plus, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_1plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_1plus should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_1plus)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_1plus <- covar_subpop_random_effects_1plus[covar_subpop_random_effect_rows_1plus,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_1plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_1plus should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_1plus)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_1plus[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect_1plus, "age")
          
          # pull out the current covariate
          covar_1plus_value <- data[, get(covars_subpop_1plus[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_1plus_value * covar_subpop_random_effect_1plus[pred_frame[, list(age)], simvars, with = F] * as.integer(pred_frame[, age >= recode$age[age == 1, age_recode]]))
          print(glue::glue("Done with loop {i}."))
        } 
      }
    }
    
    # covars_subpop_5_to_15
    if (exists("covars_subpop_5_to_15")) {
      if (length(covars_subpop_5_to_15) != 0) {
        covar_subpop_random_effects_5_to_15 <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_5_to_15",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_5_to_15))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_5_to_15[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_5_to_15) / length(covars_subpop_5_to_15)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_5_to_15 <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_5_to_15 is {paste(covar_subpop_random_effect_rows_5_to_15, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_5_to_15) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_5_to_15 should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_5_to_15)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_5_to_15 <- covar_subpop_random_effects_5_to_15[covar_subpop_random_effect_rows_5_to_15,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_5_to_15) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_5_to_15 should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_5_to_15)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_5_to_15[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect_5_to_15, "age")
          
          # pull out the current covariate
          covar_5_to_15_value <- data[, get(covars_subpop_5_to_15[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_5_to_15_value * covar_subpop_random_effect_5_to_15[pred_frame[, list(age)], simvars, with = F] * as.integer(pred_frame[, age <= recode$age[age %in% c(5:15), age_recode]]))
          print(glue::glue("Done with loop {i}."))
        } 
      }
    }
    
    # covars_subpop_65plus
    if (exists("covars_subpop_65plus")) {
      if (length(covars_subpop_65plus) != 0) {
        covar_subpop_random_effects_65plus <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_65plus",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_65plus))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_65plus[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_65plus) / length(covars_subpop_65plus)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_65plus <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_65plus is {paste(covar_subpop_random_effect_rows_65plus, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_65plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_65plus should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_65plus)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_65plus <- covar_subpop_random_effects_65plus[covar_subpop_random_effect_rows_65plus,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_65plus) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_65plus should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_65plus)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_65plus[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect_65plus, "age")
          
          # pull out the current covariate
          covar_65plus_value <- data[, get(covars_subpop_65plus[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_65plus_value * covar_subpop_random_effect_65plus[pred_frame[, list(age)], simvars, with = F] * as.integer(pred_frame[, age <= recode$age[age >= 65, age_recode]]))
          print(glue::glue("Done with loop {i}."))
        } 
      }
    }
    
    # covars_subpop_20_to_60
    if (exists("covars_subpop_20_to_60")) {
      if (length(covars_subpop_20_to_60) != 0) {
        covar_subpop_random_effects_20_to_60 <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_20_to_60",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_20_to_60))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_20_to_60[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_20_to_60) / length(covars_subpop_20_to_60)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_20_to_60 <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_20_to_60 is {paste(covar_subpop_random_effect_rows_20_to_60, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_20_to_60) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_20_to_60 should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_20_to_60)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_20_to_60 <- covar_subpop_random_effects_20_to_60[covar_subpop_random_effect_rows_20_to_60,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_20_to_60) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_20_to_60 should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_20_to_60)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_20_to_60[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect_20_to_60, "age")
          
          # pull out the current covariate
          covar_20_to_60_value <- data[, get(covars_subpop_20_to_60[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_20_to_60_value * covar_subpop_random_effect_20_to_60[pred_frame[, list(age)], simvars, with = F] * as.integer(pred_frame[, age <= recode$age[age %in% c(20:60), age_recode]]))
          print(glue::glue("Done with loop {i}."))
        } 
      }
    }
    
    if (exists("covars_subpop_5_to_60")) {
      if (length(covars_subpop_5_to_60) != 0) {
        covar_subpop_random_effects_5_to_60 <- data.table(as.matrix(sims[names(mean) == "covar_subpop_re_matrix_5_to_60",]))
        
        # add in the effect of the race/ethnicity or edu specific covariates by iterating over each of the race/ethnicity or edu specific covariates
        for (i in c(1:length(covars_subpop_5_to_60))) {
          print(glue::glue("Working on covariate number {i}: {covars_subpop_5_to_60[i]}"))
          
          # how long is each section of covar_subpop_re_matrix? that is, which entries of this vector correspond to the current covariate?
          chunk_size <- nrow(covar_subpop_random_effects_5_to_60) / length(covars_subpop_5_to_60)
          print(glue::glue("chunk_size = {chunk_size}"))
          
          # the row/index that marks the end of the current covariates chunk of covar_subpop_re_matrix
          end_row <- chunk_size * i
          
          # create an index that identifies the correct rows of covar_subpop_re_matrix. Add 1 at the start so that the index begins at 1, because row numbers in data.table begins at 1.
          begin_row <- end_row - chunk_size + 1
          print(glue::glue("begin_row is {begin_row}"))
          print(glue::glue("end_row is {end_row}"))
          
          covar_subpop_random_effect_rows_5_to_60 <- c((begin_row):(end_row))
          print(glue::glue("covar_subpop_random_effect_rows_5_to_60 is {paste(covar_subpop_random_effect_rows_5_to_60, collapse=',')}"))
          
          # check that the number of rows is correct
          if (length(covar_subpop_random_effect_rows_5_to_60) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_rows_5_to_60 should be of length {chunk_size} but instead it has length {length(covar_subpop_random_effect_rows_5_to_60)}"))
          }
          
          # subset / pull out the rows that are for this covariate
          covar_subpop_random_effect_5_to_60 <- covar_subpop_random_effects_5_to_60[covar_subpop_random_effect_rows_5_to_60,]
          
          # check that the number of rows is correct
          if (nrow(covar_subpop_random_effect_5_to_60) != chunk_size) {
            stop(glue::glue("covar_subpop_random_effect_5_to_60 should be of length {chunk_size} but instead it has {nrow(covar_subpop_random_effect_5_to_60)} rows"))
          }
          
          # include age for merging
          covar_subpop_random_effect_5_to_60[, age := 0:(num_a - 1)]
          setkeyv(covar_subpop_random_effect_5_to_60, "age")
          
          # pull out the current covariate
          covar_5_to_60_value <- data[, get(covars_subpop_5_to_60[i])]
          
          # Add these age covariate slopes to the other random effects
          print("adding to re...")
          re <- re + (covar_5_to_60_value * covar_subpop_random_effect_5_to_60[pred_frame[, list(age)], simvars, with = F] * as.integer(pred_frame[, age <= recode$age[age %in% c(5:60), age_recode]]))
          print(glue::glue("Done with loop {i}."))
        } 
      }
    }
  }
  
  if (by_source) {
    # Replicate fe for each data source so that it matches the dimensions of re
    if (length(data_file) > 1 | !is.null(names(data_file))) {
      data_file <- data.table("name" = names(data_file), "location" = data_file)
    } else {
      data_file <- data.table("name" = "Single source", "location" = data_file)
    }
    
    fe <- do.call("rbind", rep(list(fe), nrow(data_file)))
  }
  
  # calculate total draws; we recycle the fe object here to reduce memory load
  fe <- fe + re
  
  draws <- fe
  rm(fe, re); gc()
  
  # rename columns of matrixs so no col name is repeated when all imps are combined (V1, V2...V{n.imp})
  colnames(draws) <- paste0("V", ((m - 1) * draw_width + 1):(m * draw_width))
  
  draws
}

parallel::stopCluster(cl)

cols_original <- colnames(draws)

if (family == "Poisson") {
  draws <- data.table(exp(as.matrix(draws)))
} else if (family == "binomial" | family == "gaussian") {
  draws <- data.table(inv.logit(as.matrix(draws)))
}

colnames(draws) <- cols_original

#### Only generate predictions if imp = 0
#### If there are several draw-models/imputations, then predictions should be generated in 
#### combine_imputations to reduce cluster demand rather than for all draw-models/imps

#### Recode pred_frame
pred_frame_recoded <- copy(pred_frame)
if (!is.null(pred_frame_recoded$race)) {
  pred_frame_recoded <- merge(pred_frame_recoded, recode$race, by.x = "race", by.y = "race_recode")
  pred_frame_recoded[, c("race", "race.y", "var") := list(race.y, NULL, NULL)]
}
if (!is.null(pred_frame_recoded$source)) {
  pred_frame_recoded <- merge(pred_frame_recoded, recode$source, by.x = "source", by.y = "source_index_recode")
  pred_frame_recoded[, c("source", "var") := list(source_index, NULL)]
}
if (!is.null(pred_frame_recoded$source_race)) {
  pred_frame_recoded <- merge(pred_frame_recoded, recode$source_race, by.x = "source_race", by.y = "source_race_recode")
  pred_frame_recoded[, c("source", "var") := list(source_index, NULL)]
}
if (!is.null(pred_frame_recoded$sex)) {
  pred_frame_recoded <- merge(pred_frame_recoded, recode$sex, by.x = "sex", by.y = "sex_recode")
  pred_frame_recoded[, c("sex", "sex.y", "var") := list(sex.y, NULL, NULL)]
}
if (!is.null(pred_frame_recoded$year)) {
  pred_frame_recoded <- merge(pred_frame_recoded, recode$year, by.x = "year", by.y = "year_recode")
  pred_frame_recoded[, c("year", "year.y", "var") := list(year.y, NULL, NULL)]
}
if (!is.null(pred_frame_recoded$age)) {
  pred_frame_recoded <- merge(pred_frame_recoded, recode$age, by.x = "age", by.y = "age_recode")
  pred_frame_recoded[, c("age", "age.y", "var") := list(age.y, NULL, NULL)]
}
if (!is.null(pred_frame_recoded$area)) {
  pred_frame_recoded <- merge(pred_frame_recoded, recode$area, by.x = "area", by.y = "area_recode")
  pred_frame_recoded[, c("area", "mcnty", "var") := list(mcnty, NULL, NULL)]
}
if (!is.null(pred_frame_recoded$state)) {
  pred_frame_recoded <- merge(pred_frame_recoded, recode$state, by.x = "state", by.y = "state_recode")
  pred_frame_recoded[, c("state", "state.y", "var") := list(state.y, NULL, NULL)]
}
if (!is.null(pred_frame_recoded$edu)) {
  if ("edu" %in% colnames(pred_frame_recoded)) {
    pred_frame_recoded <- merge(pred_frame_recoded, recode$edu, by.x = "edu", by.y = "edu_recode")
    pred_frame_recoded[, c("edu", "edu.y", "var") := list(edu.y, NULL, NULL)]
  }
}
if (!is.null(pred_frame_recoded$marital)) {
  if ("marital" %in% colnames(pred_frame_recoded)) {
    pred_frame_recoded <- merge(pred_frame_recoded, recode$marital, by.x = "marital", by.y = "marital_recode")
    pred_frame_recoded[, c("marital", "marital.y", "var") := list(marital.y, NULL, NULL)]
  }
}
pred_frame_recoded[, int := NULL]
if (length(covars) > 0) {
  pred_frame_recoded[, (covars) := NULL]
}

# Set key (and order) of pred_frame_recoded to match pred_frame and data
if ("state" %in% names(pred_frame)) {
  setkeyv(pred_frame_recoded, c("area", "state", "year", "sex", "race", "age"))
} else {
  setkeyv(pred_frame_recoded, c("area", "year", "sex", "race", "age"))
} # same as pred_frame

#### Add pred_frame_recoded to draws
if (by_source) {
  cols <- c("area", "age", "year", "sex", "race", "source", strat_vars)
} else {
  cols <- c("area", "age", "year", "sex", "race", strat_vars)
}

draws <- cbind(draws, pred_frame_recoded[, ..cols])
if (exists("mean_preds")) {
  mean_preds <- cbind(mean_preds, pred_frame_recoded[, ..cols])
  setnames(mean_preds, "V1", "est")
}

if (!is.null(strat_vars)) {
  #### Convert factors to integers
  stratpop$age <- as.integer(as.character(stratpop$age))
  
  if ("edu" %in% strat_vars) {
    stratpop$edu <- as.integer(as.character(stratpop$edu))
  }
  if ("marital" %in% strat_vars) {
    stratpop$marital <- as.integer(as.character(stratpop$marital))
  }
  if ("phone" %in% strat_vars) {
    stratpop$phone <- as.integer(as.character(stratpop$phone))
  }
  if ("gq" %in% strat_vars) {
    stratpop$gq <- as.integer(as.character(stratpop$gq))
  }
  
  if (outcome[names(outcome) == names(data_file)[1]] %like% 'overwt') {
    draws_overwt <- copy(draws)
    if (by_sex) {
      for (s in sex) {
        saveRDS(draws_overwt[sex==s], file = paste0(output_dir_draws_est, "/draws/draws_overwt_", area_var, "_", s, "_", edu,"_", max(draw_val), ".rds"))
      }
    } else {
      saveRDS(draws_overwt, file = paste0(output_dir_draws_est, "/draws/draws_overwt_", area_var, "_", edu,"_", max(draw_val), ".rds"))
    }
  } 
  
  if (outcome[names(outcome) == names(data_file)[1]] %like% 'obese') {
    output_dir_overwt <- paste0("FILEPATH")
    if (by_sex) {
      for (s in sex) {
        draws_overwt <- readRDS(paste0(output_dir_overwt, "/draws_overwt_", area_var, "_", s, "_", edu,"_", max(draw_val), ".rds"))
      }
    } else {
      draws_overwt <- readRDS(paste0(output_dir_overwt, "/draws_overwt_", area_var, "_", edu, "_", max(draw_val),".rds"))
    }
    
    setkeyv(draws_overwt, c("area", "year", "sex", "age", "race", strat_vars))
    setkeyv(draws, c("area", "year", "sex", "age", "race", strat_vars))
    for (ss in 1:draw_width) {
      print(ss)
      col <- paste0("V", ss)
      setnames(draws, paste0("V", ss), 'col')
      draws$col <- draws$col*draws_overwt[, ..col]
      setnames(draws, 'col', paste0("V", ss))
    }
  } 
  
  #### Merge post-stratification weights onto draws
  draws <- merge(draws, stratpop, by.x = c("area", "age", "year", "sex", "race", strat_vars), 
                 by.y = c("mcnty", "age", "year", "sex", "race", strat_vars), all.x = TRUE)
  
  #### Collapse by post-stratification vars
  draws_agg <- list()
  for (ss in 1:draw_width) {
    print(ss)
    col <- paste0("V", ss)
    if (by_source) {
      draws_agg[[ss]] <- draws[, list(sim = ss, pred = weighted.mean(get(col), value, na.rm = TRUE)), by = c("area", "year", "sex", "age", "race", "source")]  
    } else {
      draws_agg[[ss]] <- draws[, list(sim = ss, pred = weighted.mean(get(col), value, na.rm = TRUE)), by = c("area", "year", "sex", "age", "race")]  
    }
  }
  draws <- rbindlist(draws_agg)
  
  #### dcast back to wide
  if (by_source) {
    draws <- dcast(draws, area + year + sex + age + race + source ~ sim, value.var = "pred") 
  } else {
    draws <- dcast(draws, area + year + sex + age + race ~ sim, value.var = "pred") 
  }
}

## Split out draws by year, calculate all-ages, age-standardized draws, collapse draws, and save ---
# load and subset the population file, then merge onto draws
if (file.exists(paste0(output_dir_draws_est, "/population.rds"))) {
  pop <- readRDS(paste0(output_dir_draws_est, "/population.rds"))
} else {
  pop <- readRDS(pop_file)
}

popage <- unique(as.character(pop$age))

if (max(popage) != max(as.character(ages)) &
    max(head(popage, -1)) == max(as.character(ages))) {
  pop[, age := ifelse(age == max(popage), max(ages), as.character(age))]
  pop <- pop[, list(pop = sum(pop)), by = c(area_var, "year", "sex", "age", "race", "state")]
  pop[, age := as.integer(as.character(age))]
}

if (!by_race) pop[, race := 1]

if (race_together) {
  if (by_sex) {
    pop <- pop[sex == get("sex", .GlobalEnv) & age %in% get("ages", .GlobalEnv), list(pop = sum(pop)), by = c(area_var, "year", "age", "race")]
    merge_vars <- c("area", "year", "age")
  } else {
    pop <- pop[age %in% get("ages", .GlobalEnv), list(pop = sum(pop)), by = c(area_var, "year", "age", "race", "sex")]
    merge_vars <- c("area", "year", "age", "sex")
  }
  merge_vars <- c(merge_vars, "race")
} else {
  if (by_sex) {
    pop <- pop[race == get("race", .GlobalEnv) & sex == get("sex", .GlobalEnv) & age %in% get("ages", .GlobalEnv),
               list(pop = sum(pop)), by = c(area_var, "year", "age")]
    merge_vars <- c("area", "year", "age")
  } else {
    pop <- pop[race == get("race", .GlobalEnv) & age %in% get("ages", .GlobalEnv),
               list(pop = sum(pop)), by = c(area_var, "year", "age", "sex")]
    merge_vars <- c("area", "year", "age", "sex")
  }
}

setnames(pop, area_var, "area")
draws <- merge(draws, pop, by = merge_vars, all.x = TRUE)

# No missing values are expected
stopifnot(!any(is.na(draws)))

# load the age standard
std_wt <- readRDS(age_std_file)[, list(age, wt = wt / sum(wt))]

# Save mean preds and params
if (exists("mean_preds")) {
  saveRDS(mean_preds, file = paste0(output_dir_draws_est, "/mean_preds_", sex, ".rds"))
  saveRDS(re_param, file = paste0(output_dir_draws_est, "/re_param_", sex, ".rds"))
}

# split up data and process separately by year
all_draws <- draws
rm(draws)

all_draws <- lapply(years, function(this_year) all_draws[year == this_year,])
for (this_year in years) {
  cat(paste(Sys.time(), this_year, "\n"))
  draws <- all_draws[[which(years == this_year)]]
  draws[, level := area_var]

  if (by_source) {
    draws <- melt(draws, id.vars = c("level", "area", "year", "sex", "race", "age", "source", "pop"), variable.name = "sim", value.name = "pred")
  } else {
    draws <- melt(draws, id.vars = c("level", "area", "year", "sex", "race", "age", "pop"), variable.name = "sim", value.name = "pred")
  }
  
  draws[, sim := as.integer(sim)]

  # re-code the draws to correspond to draw_val
  if (n.imp > 1) { # if running multiple imputations
    draws[, sim := sim + n.imp * (min(draw_val) - 1)]
  } else {
    draws[, sim := sim + (min(draw_val) - 1)]
  }
  
  # specify the columns by which to summarize/aggregate/etc since now we have both adjusted and unadjusted points
  if (by_source) {
    merge_vars <- c("level", "area", "year", "sex", "race", "source", "sim")
  } else {
    merge_vars <- c("level", "area", "year", "sex", "race", "sim")  
  }
  
  # add all-ages rates
  draws <- calc_all_ages(draws, std_wt, "pred", merge_vars)
  
  # save draws and estimates
  if (race_together) {
    for (r in races) {
      message(r)
      if (by_sex) {
        saveRDS(draws[race == r], file = paste0(output_dir_draws_est, "/draws/draws_", area_var, "_", this_year, "_", sex, "_", r, "_",
                                                max(draw_val), dir_string, ".rds"))
      } else {
        for (s in 1:2) {
          saveRDS(draws[race == r & sex == s], file = paste0(output_dir_draws_est, "/draws/draws_", area_var, "_", this_year, "_", s, "_", r, "_",
                                                             max(draw_val), dir_string, ".rds"))
        }
      }
    }
  } else {
    saveRDS(draws, file = paste0(output_dir_draws_est, "/draws/draws_", area_var, "_", this_year, "_", sex, "_", race, "_",
                                 max(draw_val), dir_string, ".rds"))
  }
  
  all_draws[[which(years == this_year)]] <- NA
  rm(draws); gc()
}
